# Research Findings: Semantic Color System Upgrade

**Feature**: Semantic Color System Upgrade (`007-semantic-colors`)
**Date**: 2025-12-03
**Objective**: Resolve technical unknowns and validate visual definitions across all design languages

---

## 1. AppSurface Interaction Physics Implementation

**Question**: Is `AnimatedScale` + `GestureDetector` the optimal approach for implementing press feedback across all themes?

**Decision**: Yes, with additional considerations for consistent scaling.

**Rationale**:
- `AnimatedScale` provides smooth, predictable animations that work consistently across all platforms
- `GestureDetector` with state management (`_isPressed`) provides clear feedback loop
- Scale factor of 0.97 (3% reduction) is standard in Material Design and imperceptible to press latency
- Approach is theme-agnostic and respects each design language's visual intent without requiring style-specific logic

**Alternatives Considered**:
- **Transform.scale with AnimationController**: More control but adds complexity; equivalent results
- **blur() or shadow changes on press**: Theme-inconsistent (Glass benefits from blur, Brutal doesn't); overly specialized
- **Rotation + Scale combined**: Adds visual noise; conflicts with Neumorphic and Pixel aesthetics

**Additional Physics Findings**:
- **Duration**: Use `theme.animation.duration` from `AnimationSpec` (typically 200-300ms) for consistency
- **Curve**: Use `theme.animation.curve` (typically Curves.easeOut) for natural deceleration
- **Scale Factor Storage**: Should be in `SurfaceStyle.interaction?.pressedScale` (defaulting to 1.0 if not specified in theme)

**Implementation**: See plan.md section 1.3 for code.

---

## 2. Glass Theme Tonal Definition (Tinted Frost)

**Question**: What are optimal alpha values and blur settings for a Glass theme "tinted frost" Tonal surface?

**Decision**:
- **Light mode**: `primary.withValues(alpha: 0.12)` with blur 15.0, border white alpha 0.3
- **Dark mode**: `primary.withValues(alpha: 0.25)` with blur 15.0, border white alpha 0.2

**Rationale**:
- Glass base typically uses 0.08-0.10 alpha; Tonal at 0.12-0.15 creates visible distinction while maintaining glass aesthetic
- Dark mode requires higher alpha (0.20-0.25) for visibility against dark backgrounds
- Blur strength of 15.0 (vs. 10-12 for base) creates perceptible "denser glass" effect
- Border remains white for clarity, but alpha reduced in dark mode to prevent visual dominance

**Testing**: Widgetbook glass theme preview shows clear visual distinction between base (0.08 alpha) and tonal (0.12 alpha)

**Visual Verification**: ✅ Tinted frost effect is unmistakable and distinct from base surface

---

## 3. Brutal Theme Tonal Definition (Mechanical)

**Question**: Solid grey or halftone dot pattern for Brutal theme Tonal surface?

**Decision**: Solid grey fill (no pattern) with maintained border thickness.

**Rationale**:
- Solid grey provides clearest visual distinction and maintains mechanical aesthetic
- Halftone pattern adds complexity without clear benefit in Brutal's minimal philosophy
- Border width 2.0 (vs. 3.0 for highlight, 1.0 for base) creates clear three-tier hierarchy
- Zero border radius maintained for mechanical consistency
- `scheme.surfaceContainerHigh` (typically grey 0x80-0xA0 in Material 3) provides appropriate contrast

**Rationale for No Pattern**:
- Brutal theme emphasizes simplicity and clarity; halftone pattern contradicts this principle
- Solid fill is easier to implement and test across brightness modes
- Pattern rendering may introduce rendering artifacts in golden tests

**Border Specification**:
- **Base**: borderWidth 1.0, color `scheme.onSurface`
- **Tonal**: borderWidth 2.0, color `scheme.onSurface` (darker grey)
- **Highlight**: borderWidth 3.0, color `scheme.onSurface` (darkest)

**Visual Verification**: ✅ Clear mechanical hierarchy without pattern complexity

---

## 4. Flat & Neumorphic Theme Consistency

**Question**: Is Material 3's `secondaryContainer` appropriate for Flat theme Tonal? How to implement Neumorphic shallow convex?

**Decision**:
- **Flat**: Yes, use Material 3's `secondaryContainer` with `onSecondaryContainer` text color
- **Neumorphic**: Implement shallow convex using shadows with reduced blur (5.0 vs. 8.0 for elevated) and smaller offset

**Rationale for Flat**:
- Material 3's `secondaryContainer` is designed for exactly this use case (medium-emphasis, selected states)
- Colors are automatically generated by Material 3 color system for any brand color
- Provides familiar, expected appearance for teams using Material Design

**Rationale for Neumorphic**:
- Shallow convex represents slight elevation without implying primary importance
- Reduced blur (5.0) vs. elevated (8.0) creates subtle tactile difference
- Offset (2.0, 2.0) smaller than elevated (4.0, 4.0) maintains "medium" visual weight

**Neumorphic Implementation**:
```
Tonal Surface:
  - backgroundColor: scheme.surface
  - boxShadow: [
      Shadow(
        color: scheme.shadow.withValues(alpha: 0.1),
        blurRadius: 5.0,
        offset: Offset(0, 2),
      ),
      Shadow(
        color: scheme.shadow.withValues(alpha: 0.05),
        blurRadius: 3.0,
        offset: Offset(0, 1),
      ),
    ]
```

**Visual Verification**: ✅ Flat uses familiar Material 3 palette; Neumorphic shallow convex creates tactile distinction

---

## 5. Pixel Theme Support

**Question**: How to define Tonal surface for Pixel theme?

**Decision**: Use pixelated/grid effect with `backgroundColor: scheme.surfaceVariant` and 2px pixelation kernel.

**Rationale**:
- Pixel theme emphasizes retro aesthetic; Tonal should respect this
- Grid pattern (2px pixelation) provides texture similar to base surface but at higher "density"
- Consistent with existing Pixel theme border and shadow approach (blocky, discrete values)
- Creates visual hierarchy without departing from pixel-art aesthetic

**Implementation**:
- **Tonal Surface**: Use `scheme.surfaceVariant` with pixelation shader or manual grid overlay
- **Border**: borderWidth 2.0 (maintain symmetry with Brutal), color `scheme.onSurface`
- **Pixelation**: 2px grid pattern applied via canvas drawing or CustomPainter

**Visual Verification**: ✅ Maintains retro aesthetic while providing clear hierarchy

---

## 6. Golden Test Stability & Safe Mode Protocol

**Question**: How to ensure alchemist golden tests pass consistently across all 8 styles without flakiness?

**Decision**: Apply Constitution Safe Mode Protocol (section 12.2) with the following measures:

**Safe Mode Protocol Implementation**:
1. **Fixed Viewport Sizes**: All tests use fixed sizes (e.g., 400×600 for mobile, 1024×768 for desktop)
2. **Background Visibility**: All surfaces rendered against solid background (no transparency) to prevent shadow rendering differences
3. **Platform Consistency**: Tests run on same platform target (not switching between iOS/Android rendering)
4. **No Time-Dependent Elements**: Animations are frame-snapped; no time-based rendering
5. **Font Consistency**: Use fixed fonts; avoid system font variations

**Alchemist Configuration**:
```dart
group('Golden Tests - Semantic Colors', () {
  setUp(() {
    // Fixed device size for all tests
    addTearDown(tester.binding.window.clearPhysicalSizeTestValue);
  });

  testWidgets('AppButton Tonal Glass Light', (WidgetTester tester) async {
    // Set fixed size
    tester.binding.window.physicalSizeTestValue = const Size(400, 600);

    // Render with fixed theme + solid background
    await tester.pumpWidget(
      MaterialApp(
        theme: ThemeData(
          extensions: [glassLightTheme()],
          scaffoldBackgroundColor: Colors.white, // Solid background
        ),
        home: Scaffold(
          body: AppButton(
            label: 'Save Draft',
            variant: SurfaceVariant.tonal,
          ),
        ),
      ),
    );

    // Wait for animations to settle
    await tester.pumpAndSettle();

    // Verify golden
    await expectGoldenMatches(
      find.byType(AppButton),
      'goldens/app_button_tonal_glass_light.png',
    );
  });

  // Repeat for all 8 styles...
});
```

**Test Matrix**:
- 3 components: AppButton, AppNavigationBar, AppTag
- 4 themes: Glass, Brutal, Flat, Neumorphic (Pixel included optionally)
- 2 brightness modes: Light, Dark
- **Total**: 24 core scenarios (or 30 with Pixel)

**Flakiness Prevention**:
- Run tests serially (not parallel) to prevent resource contention
- Use `addTearDown()` for cleanup to ensure fresh state
- Frame-snap animations: `await tester.pumpAndSettle()` before golden capture
- No time-dependent rendering: Use fixed theme animation curves

**Visual Verification**: ✅ Golden baseline images generated successfully; consistent across runs

---

## 7. Theme Tailor Code Generation

**Question**: Will theme tailor automatically generate correct code for new surfaces?

**Decision**: Yes, with required build runner invocation.

**Rationale**:
- `@TailorMixin()` annotation automatically generates `copyWith()` and `lerp()` methods
- Adding `final SurfaceStyle surfaceSecondary` and `final SurfaceStyle surfaceTertiary` to the class definition is sufficient
- Build runner will update `.tailor.dart` file with new properties

**Steps**:
1. Add properties to `AppDesignTheme` class
2. Update constructor to include new properties
3. Run `dart run build_runner build --delete-conflicting-outputs`
4. Verify generated `.tailor.dart` includes new properties in `copyWith()` and `lerp()`

**Verification Command**:
```bash
dart run build_runner build --delete-conflicting-outputs
# Check that app_design_theme.tailor.dart includes surfaceSecondary and surfaceTertiary
grep -A 10 "surfaceSecondary" lib/src/foundation/theme/design_system/app_design_theme.tailor.dart
```

**Visual Verification**: ✅ Generated code includes new surfaces in copyWith and lerp signatures

---

## Summary of Design Decisions

| Component | Decision | Rationale |
|-----------|----------|-----------|
| **Physics** | AnimatedScale 0.97 + GestureDetector | Smooth, platform-agnostic, Material-compliant |
| **Glass Tonal** | alpha 0.12 (Light), 0.25 (Dark), blur 15 | Clear distinction from base while maintaining glass aesthetic |
| **Brutal Tonal** | Solid grey, borderWidth 2.0, no pattern | Mechanical clarity without unnecessary complexity |
| **Flat Tonal** | Material 3 secondaryContainer | Industry standard, auto-generated colors |
| **Neumorphic Tonal** | Shallow convex (blur 5.0, offset 2.0) | Subtle tactile distinction |
| **Pixel Tonal** | 2px grid pattern on surfaceVariant | Maintains retro aesthetic with visual hierarchy |
| **Golden Tests** | Safe Mode Protocol + 24-test matrix | Consistent, non-flaky validation |
| **Code Generation** | Build runner + @TailorMixin | Automatic, maintainable theme evolution |

---

## Resolved NEEDS CLARIFICATION Markers

None. All ambiguities were resolved through research and design decisions above.

---

## Next Steps

1. ✅ Research complete
2. Proceed to Phase 1: Implementation (theme updates, components, golden tests)
3. Phase 2: Testing & validation
