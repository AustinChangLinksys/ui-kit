name: Deploy Docs (Widgetbook + Editor)

on:
  push:
    branches:
      - main
    paths:
      - "lib/**"
      - "widgetbook/**"
      - "editor/**"
      - "pubspec.yaml"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # 1. Quality Check
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: "stable"
      - name: Install Dependencies
        run: |
          flutter pub get
          cd editor && flutter pub get
          cd ../widgetbook && flutter pub get
      - name: Analyze Editor
        run: cd editor && flutter analyze
      - name: Analyze Widgetbook
        run: cd widgetbook && flutter analyze

  # 2. Build & Deploy (Existing logic)
  build-and-deploy:
    needs: verify # Wait for verification to pass
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"

      # --- 1. Build Widgetbook ---
      - name: Install Widgetbook Dependencies
        run: |
          flutter pub get
          cd widgetbook && flutter pub get

      - name: Run Build Runner (Widgetbook)
        run: cd widgetbook && dart run build_runner build --delete-conflicting-outputs

      - name: Build Widgetbook Web
        run: |
          cd widgetbook
          flutter build web --base-href /ui-kit/ --release

      # --- 2. Build Theme Editor ---
      - name: Install Editor Dependencies
        run: |
          cd editor && flutter pub get

      - name: Build Editor Web
        run: |
          cd editor
          flutter build web --base-href /ui-kit/editor/ --release

      # --- 3. Prepare Deployment Artifacts ---
      - name: Prepare Deployment Directory
        run: |
          mkdir -p deployment/editor
          # Copy Widgetbook to root of deployment
          cp -a widgetbook/build/web/. deployment/
          # Copy Editor to /editor subdirectory
          cp -a editor/build/web/. deployment/editor/

      # --- 4. Deploy ---
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./deployment
